<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>Anki Cram ‚Äî Mobile</title>
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14; --panel:#111722; --ink:#e8ecf1; --muted:#91a4b8;
    --border:#223046; --shadow:0 10px 30px rgba(0,0,0,.35);
    --again:#ef4444; --hard:#f59e0b; --good:#10b981; --easy:#2563eb;
    --btn:#142033; --btnHover:#1b2b44; --radius:16px;
    --fw: clamp(15px, 2.7vw, 18px);
    --card-fs: clamp(16px, 3.6vw, 22px);
    --head-fs: clamp(14px, 3vw, 18px);
    --topbar-h: 56px;
    --statsbar-h: 46px;
    --toolbar-h: 84px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%}
  html{overflow:hidden}
  body{
    margin:0; font: var(--fw)/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--ink);
    background:linear-gradient(180deg,#0b0f14,#0d1219 30%,#0c1118);
    min-height:100dvh; display:flex; flex-direction:column;
    -webkit-text-size-adjust:100%;
  }

  header.topbar{height:var(--topbar-h); display:flex; align-items:center; gap:.45rem;
    padding:0 .6rem; background:rgba(11,15,20,.9); backdrop-filter: blur(8px); border-bottom:1px solid #162234; overflow:hidden}
  .brand{display:flex; align-items:center; gap:.25rem; font-weight:700; font-size:var(--head-fs); white-space:nowrap}
  .brand-poli{color:#fff; letter-spacing:.2px}
  .brand-trauma{
    font-weight:800;
    background: linear-gradient(90deg,#ff0040,#ff7a00,#ffd400,#00d17a,#0096ff,#9b5cff,#ff3cd1);
    background-size: 200% 100%;
    background-position: 0% 50%;
    -webkit-background-clip:text; background-clip:text;
    -webkit-text-fill-color: transparent; color:transparent;
    letter-spacing:.2px;
    animation: rainbowSlide 6s linear infinite;
  }
  @keyframes rainbowSlide{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }

  .spacer{flex:1}
  input[type=file]{display:none}
  .btn{
    border:1px solid #2a3a4f; background:var(--btn); color:var(--ink);
    padding:.35rem .6rem; border-radius:10px; cursor:pointer; transition:background .15s, transform .06s;
    font-size: clamp(12px, 2.8vw, 14px); line-height:1; white-space:nowrap; flex:0 0 auto
  }
  header.topbar .btn{display:inline-flex; align-items:center; justify-content:center; height:34px}
  .btn:hover{background:var(--btnHover)} .btn:active{transform:translateY(1px)}
  .btn.danger{border-color:#5b1a1a}

  .statsbar{height:var(--statsbar-h); display:grid; grid-template-columns:repeat(3,1fr);
    gap:.5rem; align-items:center; padding:.35rem .8rem; border-bottom:1px solid #162234;
    background:rgba(12,17,24,.75); backdrop-filter: blur(6px)}
  .chip{justify-self:stretch; text-align:center; padding:.25rem .5rem; border:1px solid #263447;
    border-radius:999px; color:#9cb2c9; white-space:nowrap; overflow:visible; text-overflow:clip}

  main{position:relative; height: calc(100dvh - var(--topbar-h) - var(--statsbar-h) - var(--toolbar-h) - env(safe-area-inset-bottom));
    padding:.8rem; overflow:hidden}
  .cardwrap{position:relative; height:100%; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#0c1118,#0a0f16); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
  .dropzone{color:#a7b6c7; text-align:center; padding:1rem; width:100%}

  .stack{ position:relative; width:min(96%, 760px); height:min(96%, 100%) }
  .card{
    position:absolute; inset:0; border-radius:14px; padding:1.1rem 1.2rem; user-select:none; touch-action: none;
    background: radial-gradient(1200px 400px at 50% -10%, rgba(99,179,237,.08), transparent),
               linear-gradient(180deg,#0e1520,#0b1117 40%,#0a0f15);
    border:1px solid #1e2a3c; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
    transition: transform .22s ease, opacity .22s ease; will-change: transform, opacity;
  }
  .cardBelow{ filter:saturate(.96) brightness(.985); opacity:.97 }
  .badge{position:absolute; right:.8rem; top:.8rem; font-size:.9rem; color:#b4c5d6; pointer-events:none}
  .card h2{margin:0 0 .5rem; font-size: clamp(15px, 3.2vw, 20px); color:#cfe3ff}

  /* Contenido sin sombras ni velos */
  .face{
    white-space:pre-wrap; font-size: var(--card-fs); line-height:1.5; overflow:auto; padding-bottom:1rem;
    scrollbar-width: thin; text-shadow:none !important; background:transparent !important;
    -webkit-user-select:text; user-select:text;
  }
  .face::-webkit-scrollbar{width:8px}
  .face::-webkit-scrollbar-thumb{background:#1b2740;border-radius:8px}
  /* Quitamos cualquier sombreado inferior */
  /* .fadeBottom:after { eliminado } */

  .swipe-hint{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-weight:700; letter-spacing:.3px; color:#fff; mix-blend-mode:screen; text-shadow:0 2px 16px rgba(0,0,0,.35);
    opacity:0; border-radius: inherit; pointer-events:none;
    transition: opacity .06s linear;
  }
  @keyframes hintFlash{0%{opacity:0} 18%{opacity:1} 82%{opacity:1} 100%{opacity:0}}
  .flash{ animation: hintFlash .5s ease-in-out both }
  .hint-left {background:linear-gradient(90deg,  rgba(239,68,68,.65),  transparent)}
  .hint-right{background:linear-gradient(270deg, rgba(37,99,235,.65), transparent)}
  .hint-up   {background:linear-gradient(180deg, rgba(16,185,129,.65), transparent)}
  .hint-down {background:linear-gradient(0deg,   rgba(245,158,11,.65), transparent)}

  .exit-left { transform: translateX(-130%) rotate(-6deg); opacity:0 }
  .exit-right{ transform: translateX(130%)  rotate( 6deg); opacity:0 }
  .exit-up   { transform: translateY(-130%) rotate(-3deg); opacity:0 }
  .exit-down { transform: translateY(130%)  rotate( 3deg); opacity:0 }
  .notrans   { transition: none !important }
  .noanim    { animation: none !important }

  nav.toolbar{ position:fixed; left:0; right:0; bottom:0; z-index:40;
    background:linear-gradient(180deg,rgba(9,13,18,.4),rgba(9,13,18,.92));
    backdrop-filter: blur(12px); border-top:1px solid #162234; padding: .6rem .8rem calc(.6rem + env(safe-area-inset-bottom)) }
  .rowBtns{display:grid; grid-template-columns:repeat(4, 1fr); gap:.6rem}
  .tbtn{ display:flex; align-items:center; justify-content:center; padding: clamp(14px, 3.6vw, 18px) .4rem;
    font-size: clamp(14px, 3.2vw, 18px); border-radius:14px; color:#f2f6fb; border:1px solid transparent }
  .again{background:linear-gradient(180deg,#dc2626,#991b1b)}
  .hard {background:linear-gradient(180deg,#d97706,#9a3f05)}
  .good {background:linear-gradient(180deg,#059669,#047857)}
  .easy {background:linear-gradient(180deg,#1d4ed8,#1e40af)}
  .tiny{font-size:.9rem; color:#91a4b8; margin-top:.35rem; text-align:center}

  .sheet-panel{ position:fixed; left:0; right:0; bottom:0; z-index:50; transform: translateY(110%); transition: transform .25s ease;
    background:linear-gradient(180deg,rgba(12,17,24,.98),rgba(10,14,20,.98)); border-top:1px solid #162234; border-radius:16px 16px 0 0; padding:1rem .9rem;
    max-height:80dvh; overflow:auto }
  .sheet-open .sheet-panel{ transform: translateY(0) }
  .sheet-head{display:flex; align-items:center; gap:.6rem; margin-bottom:.6rem}
  .sheet-title{font-weight:700}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
  textarea{width:100%; min-height:110px; resize:vertical; color:#e8ecf1; background:#0c1218; border:1px solid #203249; border-radius:10px; padding:.7rem; font-family:inherit}

  input, select, textarea { font-size: 16px }

  /* Anti-long-press/selecci√≥n accidental en la tarjeta */
  .card, .card * { -webkit-touch-callout:none }
</style>
</head>
<body oncontextmenu="return false">

<header class="topbar">
  <div class="brand" aria-label="poli trauma T">
    <span class="brand-poli">poli</span><span class="brand-trauma">[traumaT]</span>
  </div>
  <div class="spacer"></div>
  <input type="file" id="file" accept=".csv,.json,text/csv,application/json" />
  <label for="file" class="btn" title="Importar CSV/JSON">üì• Importar</label>
  <button class="btn" id="exportBtn" title="Exportar JSON (baraja + progreso)">üì§ Exportar</button>
  <button class="btn danger" id="resetBtn" title="Resetear">üóëÔ∏è</button>
  <button class="btn" id="openSettingsBtn" title="Ajustes">‚öôÔ∏è</button>
</header>

<div class="statsbar">
  <div class="chip">Restantes: <b id="remStat">0</b></div>
  <div class="chip">Hechas: <b id="doneStat">0</b></div>
  <div class="chip">Dominadas: <b id="masteredStat">0</b></div>
</div>

<main>
  <section class="cardwrap" id="dropzone">
    <div class="stack" id="stack" style="display:none">
      <article class="card cardBelow" id="cardBelow" aria-hidden="true">
        <div class="badge" id="sideBadgeBelow">Frente</div>
        <h2 id="cardTitleBelow">Frente</h2>
        <div class="face" id="cardFaceBelow"></div>
      </article>
      <article class="card cardTop" id="cardTop" aria-live="polite">
        <div class="badge" id="sideBadge">Frente</div>
        <h2 id="cardTitle">Frente</h2>
        <div class="face" id="cardFace"></div>
        <div class="swipe-hint" id="swHint"></div>
      </article>
    </div>
    <div class="dropzone" id="dzHelp">
      <b>Usa ‚Äúüì• Importar‚Äù para cargar tu baraja (CSV o JSON).</b>
      <div>CSV: <code>Front,Back</code> (soporta saltos de l√≠nea entrecomillados).</div>
    </div>
  </section>

  <div class="sheet-panel" id="settingsPanel">
    <div class="sheet-head">
      <div class="sheet-title">Ajustes de sesi√≥n</div>
      <div class="spacer"></div>
      <button class="btn" id="closeSettingsBtn" title="Cerrar ajustes">‚úñ</button>
    </div>

    <div class="grid2">
      <label>Again +<input id="againPos" type="number" inputmode="numeric" value="2" min="1" class="btn" style="width:100%"></label>
      <label>Hard +<input  id="hardPos"  type="number" inputmode="numeric" value="5" min="2" class="btn" style="width:100%"></label>
      <label>Good ‚Üí<input  id="goodPos"  type="text"   value="10" class="btn" style="width:100%"></label>
      <label>Easy ‚Üí<input  id="easyPos"  type="text"   value="end" class="btn" style="width:100%"></label>
      <label>Aciertos para dominar<input id="passesNeeded" type="number" inputmode="numeric" value="1" min="1" max="10" class="btn" style="width:100%"></label>
      <label>Orden inicial
        <select id="orderSelect" class="btn" style="width:100%">
          <option value="shuffle">Aleatorio</option>
          <option value="original">Original</option>
        </select>
      </label>
    </div>

    <div style="height:.8rem"></div>
    <h3 style="margin:0 0 .4rem">Pegar CSV (opcional)</h3>
    <textarea id="pasteArea" placeholder="Pega CSV con cabeceras Front,Back..."></textarea>
    <div style="margin-top:.5rem; display:flex; gap:.6rem; flex-wrap:wrap">
      <button class="btn" id="loadPasteBtn">Cargar desde texto</button>
      <button class="btn" id="reshuffleBtn" title="Rebarajar cola">üé≤ Rebarajar</button>
      <button class="btn" id="flipStartBtn" title="Mostrar reverso al cargar">üîÑ Frente/Reverso</button>
    </div>
  </div>
</main>

<nav class="toolbar" id="toolbar">
  <div class="rowBtns" id="rowBtns">
    <button class="tbtn again" id="againBtn" aria-label="Again">Again</button>
    <button class="tbtn hard"  id="hardBtn"  aria-label="Hard">Hard</button>
    <button class="tbtn good"  id="goodBtn"  aria-label="Good">Good</button>
    <button class="tbtn easy"  id="easyBtn"  aria-label="Easy">Easy</button>
  </div>
  <div class="tiny">Gestos: ‚¨Ö Again ¬∑ ‚¨Ü Good ¬∑ ‚¨á Hard ¬∑ ‚û° Easy</div>
</nav>

<script>
/* ========= Utilidades ========= */
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQuotes=false;
  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){ if(text[i+1] === '"'){ field += '"'; i+=2; continue; } inQuotes = false; i++; continue; }
      field += c; i++; continue;
    } else {
      if(c === '"'){ inQuotes = true; i++; continue; }
      if(c === ','){ row.push(field); field=''; i++; continue; }
      if(c === '\r'){ i++; continue; }
      if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; i++; continue; }
      field += c; i++;
    }
  }
  row.push(field); rows.push(row);
  while(rows.length && rows[rows.length-1].every(x => x.trim()==='')) rows.pop();
  return rows;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
const clamp=(v,min,max)=> Math.max(min, Math.min(max, v));

/* ========= Estado ========= */
const STORAGE_KEY='ankiCram.mobile.v15.progress';
let app={
  version: 3,
  deckName:'Sin baraja',
  cards:[], queue:[], currentId:null, showBack:false,
  stats:{done:0, mastered:0},
  cfg:{ againPos:2, hardPos:5, goodPos:10, easyPos:'end', passesNeeded:1, showStart:'front', order:'shuffle' },
  meta:{},
  peekNextId:null,
  freezeBelow:false,
  animating:false
};

/* ========= Persistencia ========= */
const saveSession = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
function loadSession(){
  try{
    const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||''); if(!data) return false;
    app = migrateAndSanitize(data); renderAll(); return true;
  }catch(e){ return false; }
}

/* ========= Construcci√≥n ========= */
const makeCard=(front,back)=>({id:uid(), front, back});
function buildQueue(){
  app.queue = app.cards.map(c=>c.id);
  if(app.cfg.order==='shuffle') shuffle(app.queue);
  app.meta={}; for(const c of app.cards){ app.meta[c.id]={seen:0, streak:0, correct:0, remaining:app.cfg.passesNeeded}; }
  app.stats={done:0, mastered:0};
  app.currentId = app.queue[0] || null;
  app.showBack = (app.cfg.showStart==='back');
  app.peekNextId = null; app.freezeBelow=false; app.animating=false;
}

/* ========= Helpers ========= */
const currentCard = ()=> app.cards.find(c=>c.id===app.currentId)||null;
const cardById    = (id)=> app.cards.find(c=>c.id===id)||null;
const queueNextId = ()=> app.queue[1] || null;

/* ========= Cola ========= */
function moveCurrent(delta){
  if(app.queue.length<=1) return;
  const id = app.queue.shift();
  if(delta==='end') app.queue.push(id);
  else { const pos = Math.max(0, Math.min(app.queue.length, parseInt(delta||0,10))); app.queue.splice(pos, 0, id); }
  app.currentId = app.queue[0]; app.showBack = (app.cfg.showStart==='back');
}
function removeCurrentAsMastered(){ app.queue.shift(); app.stats.mastered += 1; app.currentId = app.queue[0] || null; }

/* ========= Hint control ========= */
const hint = ()=> document.getElementById('swHint');
function setHintDirOpacity(dir, opa){
  const h = hint();
  h.classList.remove('flash'); h.classList.add('noanim');
  h.className = 'swipe-hint ' + (dir==='left'?'hint-left':dir==='right'?'hint-right':dir==='up'?'hint-up':'hint-down');
  h.style.opacity = String(clamp(opa,0,1));
}
function clearHint(){
  const h = hint();
  h.classList.add('noanim');
  h.classList.remove('flash','hint-left','hint-right','hint-up','hint-down');
  h.className = 'swipe-hint';
  h.style.opacity='0';
  void h.offsetHeight; h.classList.remove('noanim');
}
function flashHintFinal(dir){
  const h = hint();
  h.classList.remove('noanim','flash');
  h.className = 'swipe-hint ' + (dir==='left'?'hint-left':dir==='right'?'hint-right':dir==='up'?'hint-up':'hint-down');
  void h.offsetWidth;
  h.classList.add('flash');
  setTimeout(clearHint, 520);
}

/* ========= Nota / calificaci√≥n ========= */
function performGrade(action){
  const c=currentCard(); if(!c) return;
  const m=app.meta[c.id] || (app.meta[c.id]={seen:0,streak:0,correct:0,remaining:app.cfg.passesNeeded});
  m.seen+=1;

  if(action==='again'){ m.streak=0; app.stats.done+=1; moveCurrent(app.cfg.againPos); }
  else if(action==='hard'){ m.streak=Math.max(0, m.streak-1); app.stats.done+=1; moveCurrent(app.cfg.hardPos); }
  else if(action==='good'){ m.streak+=1; m.correct+=1; m.remaining = Math.max(1, app.cfg.passesNeeded - m.streak); moveCurrent(app.cfg.goodPos); }
  else if(action==='easy'){ m.streak+=2; m.correct+=1; m.remaining = Math.max(0, app.cfg.passesNeeded - m.streak);
    if(m.remaining===0){ app.stats.done+=1; removeCurrentAsMastered(); } else { moveCurrent(app.cfg.easyPos); }
  }
}

/* ========= Orquestador salida ========= */
function gradeFromDir(dir, currentDrag){
  if(app.animating) return;
  app.animating = true;

  const action = dir==='left' ? 'again' : dir==='right' ? 'easy' : dir==='up' ? 'good' : 'hard';
  flashHintFinal(dir);
  applyExit(action, currentDrag, ()=>{
    performGrade(action);
    app.peekNextId = null; app.freezeBelow=false;
    app.animating = false;

    swapNoTransition(()=>{
      clearHint();
      renderAll();
    });
    saveSession();
  });
}

/* ========= Animaci√≥n salida ========= */
function applyExit(action, dragState, done){
  const el = document.getElementById('cardTop');
  const {dx=0, dy=0} = dragState || {};
  const startRot = clamp(dx*0.06, -6, 6);
  el.style.transition='none';
  el.style.transform = `translate(${dx}px, ${dy}px) rotate(${startRot}deg)`;
  el.style.filter='';

  let endTransform = '';
  if(action==='again') endTransform = 'translateX(-130%) rotate(-6deg)';
  else if(action==='easy') endTransform = 'translateX(130%) rotate(6deg)';
  else if(action==='good') endTransform = 'translateY(-130%) rotate(-3deg)';
  else endTransform = 'translateY(130%) rotate(3deg)';

  const rect = document.getElementById('stack').getBoundingClientRect();
  const magNow = Math.hypot(dx,dy), diag = Math.hypot(rect.width, rect.height);
  const remainRatio = clamp(1 - magNow/(diag*0.7), 0, 1);
  let dur = 200 + Math.round(140*remainRatio); dur = clamp(dur, 200, 340);

  let finished=false;
  const finish = ()=>{
    if(finished) return; finished=true;
    el.classList.add('notrans'); el.style.transition=''; el.style.transform=''; el.style.opacity=''; el.style.filter='';
    void el.offsetHeight; el.classList.remove('notrans');
    done && done();
  };

  requestAnimationFrame(()=>{
    el.style.transition = `transform ${dur}ms ease, opacity ${dur}ms ease`;
    el.style.transform  = endTransform; el.style.opacity = '0';
  });

  const to = setTimeout(finish, dur+100);
  el.addEventListener('transitionend', ()=>{ clearTimeout(to); finish(); }, {once:true});
}

/* ========= Swap sin transiciones ========= */
function swapNoTransition(mutator){
  const top = document.getElementById('cardTop');
  const below = document.getElementById('cardBelow');
  top.classList.add('notrans'); below.classList.add('notrans');
  mutator && mutator();
  void top.offsetHeight; void below.offsetHeight;
  top.classList.remove('notrans'); below.classList.remove('notrans');
}

/* ========= Render ========= */
function renderAll(){ renderStats(); renderStack(); }
function renderStats(){
  remStat.textContent = String(app.queue.length);
  doneStat.textContent = String(app.stats.done||0);
  masteredStat.textContent = String(app.stats.mastered||0);
}
function fillCard(elPrefix, cardObj, showBack=false){
  const badge = document.getElementById(elPrefix==='Top'?'sideBadge':'sideBadgeBelow');
  const title = document.getElementById(elPrefix==='Top'?'cardTitle':'cardTitleBelow');
  const face  = document.getElementById(elPrefix==='Top'?'cardFace':'cardFaceBelow');
  const art   = document.getElementById('card'+elPrefix);
  if(!cardObj){ art.style.display='none'; face.textContent=''; return; }
  art.style.display='flex';
  const isBack = showBack;
  const label = isBack ? 'Reverso' : 'Frente';
  badge.textContent = label;
  title.textContent = label;
  face.textContent  = isBack ? cardObj.back : cardObj.front;
  face.scrollTop = 0;
}
function renderStack(){
  const stack = document.getElementById('stack'), help = document.getElementById('dzHelp');
  const c = currentCard();
  if(!c){ stack.style.display='none'; help.style.display='block'; return; }
  help.style.display='none'; stack.style.display='block';
  clearHint();
  fillCard('Top', c, app.showBack);
  const nextId = (app.freezeBelow && app.peekNextId) ? app.peekNextId : queueNextId();
  const n = nextId ? cardById(nextId) : null;
  const showBelowBack = (app.cfg.showStart==='back');
  fillCard('Below', n, showBelowBack);
}

/* ========= Gestos con Pointer Events (tap flip; long-press no hace nada) ========= */
(function gestures(){
  const el=document.getElementById('cardTop');
  let sx=0, sy=0, dx=0, dy=0, tracking=false, activePointer=null;
  const TAP_TH=18, COMMIT_TH=64, MAX_OPA_DIST=90;

  const direction=(dx,dy)=> (Math.abs(dx)>Math.abs(dy)) ? (dx>0?'right':'left') : (dy>0?'down':'up');

  function start(x,y, e){
    if(app.animating || tracking) return;
    e.preventDefault?.();
    sx=x; sy=y; dx=0; dy=0; tracking=true; activePointer=e.pointerId ?? 'mouse';
    app.peekNextId = queueNextId();
    app.freezeBelow = true;
    swapNoTransition(()=> renderStack());
    el.style.transition='';
    el.style.filter='';
    el.setPointerCapture?.(e.pointerId);
  }
  function move(x,y, e){
    if(!tracking || app.animating) return;
    if(e && activePointer!=null && e.pointerId!==activePointer) return;
    dx = x - sx; dy = y - sy;
    const rot = clamp(dx*0.06, -6, 6);
    el.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;

    const mag = Math.hypot(dx,dy);
    const dir = direction(dx,dy);
    const ratio = clamp(mag / MAX_OPA_DIST, 0, 1);
    const strong = clamp(Math.pow(ratio, 0.6) * 1.35, 0, 1);
    setHintDirOpacity(dir, strong);

    const sat = 1 + strong * 0.45;
    const bright = 1 + strong * 0.18;
    el.style.filter = `saturate(${sat}) brightness(${bright})`;
  }
  function end(x,y, e){
    if(!tracking) return;
    if(e && activePointer!=null && e.pointerId!==activePointer) return;
    tracking=false; activePointer=null;
    const ddx = x - sx, ddy = y - sy;
    const mag = Math.hypot(ddx,ddy);
    clearHint(); el.style.filter='';
    e?.preventDefault?.();

    if(mag < TAP_TH){
      app.showBack = !app.showBack;
      swapNoTransition(()=> renderStack());
      el.style.transition='transform .14s ease'; el.style.transform='';
      app.peekNextId = null; app.freezeBelow=false;
      return;
    }
    const dir = direction(ddx,ddy);
    if(mag >= COMMIT_TH){
      gradeFromDir(dir, {dx:ddx, dy:ddy});
    } else {
      el.style.transition='transform .16s ease'; el.style.transform='';
      app.peekNextId = null; app.freezeBelow=false;
      clearHint(); el.style.filter='';
    }
  }

  el.addEventListener('pointerdown', e => start(e.clientX, e.clientY, e), {passive:false});
  el.addEventListener('pointermove',  e => move(e.clientX,  e.clientY,  e), {passive:false});
  el.addEventListener('pointerup',    e => end(e.clientX,   e.clientY,   e), {passive:false});
  el.addEventListener('pointercancel', e=>{ tracking=false; activePointer=null; clearHint(); el.style.filter=''; });
})();

/* ========= Botones ========= */
function freezeForButton(){
  if(app.animating) return;
  app.peekNextId = queueNextId();
  app.freezeBelow = true;
  swapNoTransition(()=> renderStack());
}
againBtn.onclick = ()=>{ freezeForButton(); gradeFromDir('left',  {dx:-80, dy:0}); };
hardBtn.onclick  = ()=>{ freezeForButton(); gradeFromDir('down',  {dx:0, dy: 80}); };
goodBtn.onclick  = ()=>{ freezeForButton(); gradeFromDir('up',    {dx:0, dy:-80}); };
easyBtn.onclick  = ()=>{ freezeForButton(); gradeFromDir('right', {dx: 80, dy:0}); };

/* ========= Panel ajustes ========= */
const bodyEl = document.body;
openSettingsBtn.onclick = ()=> bodyEl.classList.add('sheet-open');
closeSettingsBtn.onclick = ()=> bodyEl.classList.remove('sheet-open');

['againPos','hardPos','goodPos','easyPos','passesNeeded','orderSelect'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    app.cfg.againPos = parseInt(againPos.value,10)||2;
    app.cfg.hardPos  = parseInt(hardPos.value,10)||5;
    const g = parseInt(goodPos.value,10);
    app.cfg.goodPos  = isNaN(g) ? (goodPos.value||'end') : g;
    app.cfg.easyPos  = (easyPos.value||'end');
    app.cfg.passesNeeded = Math.max(1, parseInt(passesNeeded.value,10)||1);
    app.cfg.order = orderSelect.value;
    for(const id in app.meta){ const m=app.meta[id]; m.remaining = Math.max(1, app.cfg.passesNeeded - m.streak); }
    renderAll(); saveSession();
  });
});

/* ========= Import / Export (progreso completo) ========= */
function sanitizeQueue(ids){
  const valid = new Set(app.cards.map(c=>c.id));
  return (ids||[]).filter(id=>valid.has(id));
}
function migrateAndSanitize(obj){
  let out = {...app, ...obj};
  out.version = 3;
  out.cards = (out.cards||[]).map(c=>({id: c.id || uid(), front: c.front||'', back: c.back||''}));
  const meta={}
  for(const c of out.cards){
    const m=(out.meta||{})[c.id]||{};
    meta[c.id]={ seen: m.seen|0, streak: m.streak|0, correct: m.correct|0,
                 remaining: Math.max(1, (out.cfg?.passesNeeded ?? app.cfg.passesNeeded) - (m.streak|0)) };
  }
  out.meta=meta;
  out.queue = sanitizeQueue(out.queue?.length ? out.queue : out.cards.map(c=>c.id));
  if(!out.queue.length) out.queue = out.cards.map(c=>c.id);
  if(!out.currentId || !out.queue.includes(out.currentId)) out.currentId = out.queue[0] || null;
  out.cfg = {...app.cfg, ...(out.cfg||{})};
  out.stats = {done: out.stats?.done|0, mastered: out.stats?.mastered|0};
  out.showBack = !!out.showBack;
  out.peekNextId=null; out.freezeBelow=false; out.animating=false;
  return out;
}

function deckFromCSV(text){
  const rows=parseCSV(text); if(!rows.length) throw new Error('CSV vac√≠o');
  const header=rows[0].map(h=>h.trim().toLowerCase());
  const iF=header.indexOf('front'), iB=header.indexOf('back');
  if(iF<0||iB<0) throw new Error('Cabeceras requeridas: Front,Back');
  const cards=[]; for(let r=1;r<rows.length;r++){
    const front=(rows[r][iF]??'').trim(), back=(rows[r][iB]??'').trim();
    if(front||back) cards.push(makeCard(front,back));
  }
  if(!cards.length) throw new Error('No se encontraron tarjetas v√°lidas.');
  return cards;
}

async function importText(text, nameGuess='Baraja'){
  try{
    const obj=JSON.parse(text);
    if(obj && (Array.isArray(obj.cards) || Array.isArray(obj.queue))){
      const restored = migrateAndSanitize(obj);
      restored.deckName = obj.deckName || nameGuess;
      app = restored;
      saveSession(); renderAll(); return;
    }
    if(Array.isArray(obj) && obj.length && (obj[0].front!==undefined || obj[0].Front!==undefined)){
      app.deckName = nameGuess;
      app.cards = obj.map(o=>({id: uid(), front: o.front ?? o.Front ?? '', back: o.back ?? o.Back ?? ''}));
      buildQueue(); saveSession(); renderAll(); return;
    }
    throw new Error('JSON no reconocido');
  }catch(_){
    const cards = deckFromCSV(text);
    app.deckName = nameGuess; app.cards = cards; buildQueue(); saveSession(); renderAll();
  }
}

file.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text(); await importText(txt, f.name.replace(/\.(csv|txt|json)$/i,''));
  e.target.value='';
});
loadPasteBtn.addEventListener('click', ()=>{
  const txt=pasteArea.value; if(!txt.trim()) return alert('Pega contenido primero.');
  importText(txt, 'Pegado ' + new Date().toLocaleString());
});

// Exporta PROGRESO completo
exportBtn.addEventListener('click', ()=>{
  const payload = {
    version: app.version,
    deckName: app.deckName,
    exportedAt: new Date().toISOString(),
    cfg: app.cfg,
    stats: app.stats,
    cards: app.cards,
    meta: app.meta,
    queue: app.queue,
    currentId: app.currentId,
    showBack: app.showBack
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: (app.deckName || 'baraja') + '.anki-cram.json'});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});

/* ========= Reset ========= */
resetBtn.onclick = ()=>{
  if(confirm('¬øResetear sesi√≥n (estad√≠sticas y cola)?')){ buildQueue(); renderAll(); saveSession(); }
};

/* ========= Extra ========= */
reshuffleBtn.addEventListener('click', ()=>{
  const cur=currentCard(); shuffle(app.queue);
  if(cur){ const i=app.queue.indexOf(cur.id); if(i>0){ app.queue.splice(i,1); app.queue.unshift(cur.id); } }
  renderAll(); saveSession();
});
flipStartBtn.addEventListener('click', ()=>{
  app.cfg.showStart = (app.cfg.showStart==='front'?'back':'front'); saveSession();
});

/* ========= Init ========= */
(function init(){ if(!loadSession()){ renderAll(); } })();
</script>
</body>
</html>
